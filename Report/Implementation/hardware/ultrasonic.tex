%mainfile: ../../master.tex
\subsection{Ultrasonic Sensor}\label{sub:ultrasonic}
The are number of different sensors for different purposes, depending on the purpose, they are based on following physical principles:
\begin{itemize}
  \item time of flight - for measuring a distance, thickness or integrity\cite{ultrasound2}
  \item the Doppler effect - for measuring speed\cite{ultrasound}
  \item the attenuation of sound waves - for measuring distance or directionality\cite{ultrasound}
\end{itemize}
The sensor HC-SR04 in consideration is utilizing time of flight principle. This sensor emit out a high-frequency (40 kHz) pulse, it then measures the time it takes for an echo of the pulse to reflect back. The sensor has 2 openings on its front. One opening emits ultrasonic waves, it acts as a speaker, a transmitter, the other receives them, acts as a microphone, a receiver. \cref{fig:ultrasonicwiring} illustrates the setup of an arduino and the sensor, here depict as two speakers. 

\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.4\textwidth]{arduino-ultrasonic-wiring.png}
  \caption{The setup of the ultrasonic sensor testbed}
  \label{fig:ultrasonicwiring}
\end{figure}

\paragraph{Operation of the sensor}
The HC-SR04 sensor operates by following the description and \cref{fig:sensor-workings} suggests, firstly the sensors measuring mechanism is activated by setting the "TRIGGER" pin to high for 10$\si{\milli\second}$, now the sensor begin the measuring cycles, consisting of 8 consecutive transmit-receiver periods. At last the the sensor outputs the time it took for a ultrasonic to be transmitted and be received again, through the "ECHO" pin, this is then convertible into a distance by the following formula $L = (C × T)/2$, where $L$ is the distance, $C$ is the speed of sound, $T$ is the time it took for the wave to travel back and fourth, hence also why we divide by 2.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=\textwidth]{sensor-workings.png}
  \caption{HC-SR04 timing diagram}
  \label{fig:sensor-workings}
\end{figure}

\paragraph{The technology}
Ultrasonic sound waves is at frequencies above human auditorial capability, often at 40 kHz. Ultrasonic sound has a number of properties, relative to human audible sound, that can be exploited when in need of measuring the speed\cite{ultrasound}, thickness\cite{ultrasound2}, integrity\cite{ultrasound2} of an object, but also a distance to object as will be useful in this context. These properties include the attenuation and reflectiveness of higher frequency waves and not being audible to humans.\chnote{more?} The sensors utilising this technology are very useful for making measurements without touching or otherwise impeding a target. However, these following factors has to be taking into consideration in that may affect measurements.
  \subparagraph{Considerations}\label{sup:cons}
  \begin{itemize}
  \item Temperatures and humidity affect the speed of sound in air
  \item Temperature variations and air currents can act as invisible boundaries that will reflect ultrasonic waves
  \item The angle of the objects being observed. For the transmitted wave to echoed back to the receiver, the surface of the target must be  near perpendicular to the transmitter. Therefore the angle of the object with respect to the sensor does not exceed a particular range
  \item Pulsing ultrasonic sensors may have a “dead zone” immediately in front of them, in which objects will be detected correctly because they may reflect the wave before the receiver is operational, to avoid reverberations
  \item Some materials may be more absorbent than others, and will therefore reflect less ultrasonic waves
  \end{itemize}

\paragraph{The purpose} of the ultrasonic sensor in this project is figure out if a person is at a specific location in the problem domain e.g. sitting in the sofa watching TV, where the PIR sensor in\cref{sub:pir}, is only capable of the measuring changes in infrared light over a larger <120 degrees angle(According to the specification sheet)\cref{subp:AngPartial_conclusion}, this sensor is capable of measuring a distance to an specific object e.g. a person. The distance is measured every second, so where is the PIR sensor would not capable of tracking a person if the person is not moving, the ultrasonic can detect a person by a change in distance from static state.

\paragraph{The tests} of the sensors will include some aspects of the considerations mentioned above, also some tests on the values mentioned in the HC-SR04 datasheet\cite{hcsr04}. The tests will be performed on 3 identical HC-SR04 sensors. The pictures \crefrange{fig:ultra1}{fig:ultra3} depicts how the test where carried out.

\begin{figure}[htbp]
  \begin{subfigure}{.3\textwidth}
    \centering
    \includegraphics[width=\textwidth]{ultra1.jpg}
    \caption{bla}
    \label{fig:ultra1}
  \end{subfigure}
  \begin{subfigure}{.3\textwidth}
    \centering
    \includegraphics[width=\textwidth]{ultra2.jpg}
    \caption{bla}
    \label{fig:ultra2}
  \end{subfigure}
  \begin{subfigure}{.3\textwidth}
    \centering
    \includegraphics[width=\textwidth]{ultra3.jpg}
    \caption{bla}
    \label{fig:ultra3}
  \end{subfigure}
\end{figure}
  
  \subparagraph{Distance}
  First the accuracy of the sensors over different distances will be tested, through this process the minimum and maximum range of the sensors will be discovered. 
  \begin{table}[htbp]
    \centering
    \begin{adjustbox}{max width=\textwidth}
      \begin{tabular}{c*{15}{c}}
      \toprule
                      & \multicolumn{5}{c}{Sensor 1} & \multicolumn{5}{c}{Sensor 2} & \multicolumn{5}{c}{Sensor 3} \\ 
                        \cmidrule(rl){2-6}             \cmidrule(rl){7-11}            \cmidrule(rl){12-16}
        Distance [cm] & 0\degree of object & 10\degree & 20\degree & 35\degree & 45\degree & 0\degree & 10\degree & 20\degree & 35\degree & 45\degree & 0\degree & 10\degree & 20\degree & 35\degree & 45\degree \\
        \midrule
        0             & 5   & .*  & .   & .   & .   & 5   & .   & .   & . & . & 4   & .   & . & . & . \\ 
        1             & 2   & 2   & 2   & 2   & -   & 2   & 2   & -   & - & - & 2   & 2   & - & - & - \\ 
        2             & 2   & 2   & 3   & 3   & 3   & 2   & 2   & -   & - & - & 2   & 2   & - & - & - \\ 
        3             & 3   & 3   & 3   & 3   & 4   & 3   & 3   & -   & - & - & 3   & 3   & - & - & - \\ 
        4             & 4   & 4   & 4   & 4   & 4   & 4   & 4   & -   & - & - & 4   & 4   & - & - & - \\ 
        5             & 5   & 5   & 5   & 6   & 8   & 5   & 5   & -   & - & - & 5   & 5   & - & - & - \\ 
        10            & 10  & 10  & 9   & 57  & 60  & 10  & 10  & -   & - & - & 10  & 10  & - & - & - \\ 
        20            & 20  & 20  & 19  & 96  & 60  & 20  & 20  & -   & - & - & 20  & 20  & - & - & - \\ 
        40            & 39  & 39  & 38  & 98  & 56  & 39  & 39  & -   & - & - & 39  & 39  & - & - & - \\ 
        80            & 78  & 77  & 74  & 69  & x   & 78  & -   & -   & - & - & 79  & -   & - & - & - \\ 
        160           & 157 & 154 & 148 & 137 & x   & 157 & -   & -   & - & - & 157 & -   & - & - & - \\ 
        320           & 313 & -   & -   & -   & -   & 313 & -   & -   & - & - & 315 & -   & - & - & - \\ 
        450           & 445 & -   & -   & -   & -   & 445 & -   & -   & - & - & 466 & -   & - & - & - \\ 
        570           & 565 & -   & -   & -   & -   & -   & -   & -   & - & - & 566 & -   & - & - & - \\ 
        600           & x   & -   & -   & -   & -   & 595 & -   & -   & - & - & x   & -   & - & - & - \\
        \bottomrule
      \end{tabular}
    \end{adjustbox}
    \caption{Distance test, x marks unstable measurements, and - marks missing. *Does not make sense to measure an angle at 0 distance}
    \label{tab:ult_distance}
  \end{table}
  \begin{figure}[htbp]
    \centering
    \begin{tikzpicture}    
      \begin{axis}[
                    samples=14,
                    title={Precision experiment 0\degree},
                    xlabel={Actual distance [$\si{\centi\meter}$]},
                    ylabel={Measure distance [$\si{\centi\meter}$]},
                    %xtick={0,1,2,3,4,5,10,20,40,80,160,320,450,570,600},
                    %ytick={0,1,2,3,4,5,10,20,40,80,160,320,450,570,595},
                    %xmode = linear,
                    %ymode = linear, 
                    legend pos= north west,
                    ymajorgrids=true,
                    grid style=dashed
                  ]
        \input{Implementation/hardware/UltrasonicPlots/plot0angle}
      \end{axis}
    \end{tikzpicture}
    \caption{Distance test at 0 degrees angle, at 570 cm sensor 1 and 3 stopped supplying stable reliable answers.}
    \label{fig:ult_precision}
  \end{figure}
%  \begin{figure}[htbp]
%    \centering
%    \begin{tikzpicture}    
%      \begin{axis}[
%                    samples=14,
%                    title={Precision experiment 10\degree},
%                    xlabel={Actual distance [$\si{\centi\meter}$]},
%                    ylabel={Measure distance [$\si{\centi\meter}$]},
%                    %xtick={0,1,2,3,4,5,10,20,40,80,160,320,450,570,600},
%                    %ytick={0,1,2,3,4,5,10,20,40,80,160,320,450,570,595},
%                    %xmode = linear,
%                    %ymode = linear, 
%                    legend pos= north west,
%                    ymajorgrids=true,
%                    grid style=dashed
%                  ]
%        \input{Implementation/hardware/UltrasonicPlots/plot10angle}
%      \end{axis}
%    \end{tikzpicture}
%    \caption{Distance test at 10 degrees angle}
%    \label{fig:ult_precision2}
%  \end{figure}

  \subparagraph{Angle of sensor}
  The angle of the field the sensor measures within is tested, see \cref{fig:ult_angle}. This gives an idea of the how directed to sensor is, and thereby at what span the sensor is able to detect an object.
  \begin{table}[htbp]
    \centering
    \begin{adjustbox}{max width=\textwidth}
      \begin{tabular}{c*{13}{c}}
      \toprule
        Distance [cm] & -30\degree & -25\degree & -20\degree & -15\degree & -10\degree & -5\degree & 0\degree & 5\degree & 10\degree & 15\degree & 20\degree & 25\degree & 30\degree \\ 
        \midrule
        15            & x & x  & x & 16 & 16 & 15 & 15 & 15 & 16 & 17 & x  & x & x \\ 
        30            & x & x & 31 & 30 & 30 & 30 & 30 & 30 & 30 & 30 & 31 & x & x \\ 
      \bottomrule
      \end{tabular}
    \end{adjustbox}
    \caption{Sensor angle test}
    \label{tab:ult_angle}
  \end{table}
  The sensor is able to detect an object effectively at an angle of -20\degree to 20\degree, fairly precisely.
  
  \subparagraph{Test observations} All of the sensor are pretty much identical, they reasonably accurate within 6 meters, see \cref{tab:ult_distance} and \cref{fig:ult_precision}, when an object within +/-15\degree of the sensors center and its surface facing the sensor with a 20\degree angle, see \cref{tab:ult_angle}.
  
\paragraph{Multiple ultrasonic sensors} in the problem domain may introduction interference in the measurements performed, in that if one sensor is capable of transmitting sound waves to another sensor it is possible that this will result in a collision. If this is to be solved it is important that a collision is detectable or does simply not happen. Getting collision free measurements requires some coordination between sensors, who will talk when. Example of a solution, each sensor is given a timeslot, in which a sensor is allowed to speak, it is important that there is slight delay between each timeslot to ensure that the sounds wave has attenuated.\chnote{måske noget om dynamisk kunne tilslutte frakoble sensors}
