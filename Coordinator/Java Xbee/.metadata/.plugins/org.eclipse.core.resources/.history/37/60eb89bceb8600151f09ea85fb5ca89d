/**
 * Copyright (c) 2014-2015 Digi International Inc.,
 * All rights not expressly granted are reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Digi International Inc. 11001 Bren Road East, Minnetonka, MN 55343
 * =======================================================================
 */
import com.digi.xbee.api.XBeeDevice;
import com.digi.xbee.api.exceptions.XBeeException;
import com.digi.xbee.api.models.XBeeMessage;
import com.digi.xbee.api.utils.HexUtils;


public class MainApp {

	/* Constants */

	// TODO Replace with the serial port where your receiver module is
	// connected.
	private static final String PORT = "COM5";
	// TODO Replace with the baud rate of you receiver module.
	private static final int BAUD_RATE = 9600;


	public static void main(String[] args) {

		XBeeDevice myDevice = new XBeeDevice(PORT, BAUD_RATE);

		while (true) {
			XBeeMessage xBMsg = RecieveData(myDevice);
			if (xBMsg != null) {

				System.out.format("From %s >> %s | %s%n", xBMsg.getDevice()
						.get64BitAddress(), HexUtils.prettyHexString(HexUtils
						.byteArrayToHexString(xBMsg.getData())), new String(
						xBMsg.getData()));
				String toSend = "AAAAA";
				BroadcastSend(toSend.getBytes(), myDevice);
			}
		}

	}

	public static XBeeMessage RecieveData(XBeeDevice myDevice) {
		System.out.println(" +-----------------------------------------+");
		System.out.println(" |  XBee Java Library Data Polling Sample  |");
		System.out.println(" +-----------------------------------------+\n");

		try {
			myDevice.open();
			XBeeMessage xBeeMsg = myDevice.readData(1000);
			myDevice.close();

			return xBeeMsg;
		} catch (XBeeException e) {
			e.printStackTrace();
			return null;
		}

	}

	public static void BroadcastSend(byte[] dataToSend, XBeeDevice myDevice) {
		System.out
				.println(" +------------------------------------------------+");
		System.out
				.println(" |  XBee Java Library Send Broadcast Data Sample  |");
		System.out
				.println(" +------------------------------------------------+\n");

		try {
			myDevice.open();

			System.out.format("Sending broadcast data: '%s'...%n", new String(
					dataToSend));

			myDevice.sendBroadcastData(dataToSend);

			System.out.println("Success");

		} catch (XBeeException e) {
			System.out.println("Error");
			e.printStackTrace();
			System.exit(1);
		} finally {
			myDevice.close();
		}
	}

}
